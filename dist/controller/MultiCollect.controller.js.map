{"version":3,"file":"MultiCollect.controller.js","names":["BaseController","_interopRequireDefault","__BaseController","MultiCollect","extend","onAfterRendering","_onAfterRendering","disableComboBox","onInit","_onInit","BaseController.prototype.onInit.call","oRouter","UIComponent","getRouterFor","getRoute","attachMatched","_initialFunc","initTableSelections","deliveryModel","getDelivModel","setProperty","collects","loadCollects","length","onNavBack","map","col","reqNumber","loadItems","_loadItems","allItems","i","fetch","then","res","json","data","items","filter","item","requestId","push","_loadCollects","collectsList","getProperty","selCollects","coll","selected","el","onStartCollectDialog","_onStartCollectDialog","oEvent","onFragmentHandler","setTimeout","cancelFragment","_filter","table","getView","byId","oBinding","getBinding","filters","collectFilters","searchFilter","Filter","FilterOperator","Contains","collectOrFilters","collectFilter","EQ","and","onFinishCollects","_onFinishCollects","getItems","getSelectedItems","navTo","groupByCollectReq","MessageBox","show","_groupByCollectReq","collectsItems","groupedCollects","collect","collectItems","console","log"],"sources":["../../src/controller/MultiCollect.controller.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\r\n/* eslint-disable @typescript-eslint/no-unsafe-call */\r\n/* eslint-disable @typescript-eslint/no-unsafe-member-access */\r\n\r\nimport UIComponent from \"sap/ui/core/UIComponent\";\r\nimport BaseController from \"./BaseController\";\r\nimport JSONModel from \"sap/ui/model/json/JSONModel\";\r\nimport Event from \"sap/ui/base/Event\";\r\nimport Table from \"sap/m/Table\";\r\nimport ListBinding from \"sap/ui/model/ListBinding\";\r\nimport Filter from \"sap/ui/model/Filter\";\r\nimport FilterOperator from \"sap/ui/model/FilterOperator\";\r\nimport MessageBox from \"sap/m/MessageBox\";\r\nimport { IAccessType, ICollectRequest } from \"./Main.controller\";\r\n\r\n\r\nexport type ICollectItem = {\r\n    reqNumber?: number\r\n    num: string\r\n    requestId: string\r\n    catNum: string\r\n    desc: string\r\n    unit: string\r\n    amount: string\r\n    invAmount: string\r\n    locat: string\r\n    sortNum: string\r\n    accessType: IAccessType\r\n    isMochlol: boolean,\r\n    isDanger: boolean\r\n    armorId: string\r\n    selected?: boolean\r\n\r\n}\r\n\r\n/**\r\n * @namespace icl.delivery.controller\r\n */\r\nexport default class MultiCollect extends BaseController {\r\n    onAfterRendering() {\r\n        this.disableComboBox('noWriteCombo3')\r\n    }\r\n\r\n    onInit() {\r\n        super.onInit();\r\n        const oRouter = UIComponent.getRouterFor(this);\r\n        // eslint-disable-next-line @typescript-eslint/unbound-method\r\n        oRouter.getRoute(\"multiCollect\").attachMatched(this._initialFunc, this);\r\n    }\r\n    public _initialFunc() {\r\n\r\n        this.initTableSelections('multiItemsTable');\r\n\r\n        const deliveryModel = this.getDelivModel();\r\n        deliveryModel.setProperty('/oFlags/headerNavBack', true);\r\n        deliveryModel.setProperty('/currView', 'multiCollect');\r\n        const collects = this.loadCollects(deliveryModel);\r\n        if (!collects.length) { this.onNavBack() }\r\n        deliveryModel.setProperty('/oMaintain/multiCollect/collectFilter', collects.map(col => col.reqNumber));\r\n\r\n        void this.loadItems(deliveryModel, collects);\r\n    }\r\n    async loadItems(deliveryModel: JSONModel, collects: ICollectRequest[]) {\r\n        const allItems: ICollectItem[] = []\r\n        // fetch all selected collects items\r\n        for (let i = 0; i < collects.length; i++) {\r\n            await fetch(\"/mockData/collectItems.JSON\")\r\n                .then(res => res.json())\r\n                .then((data: ICollectItem[]) => {\r\n                    const items = data.filter(item => {\r\n                        if (item.requestId === collects[i].requestId) {\r\n                            item.reqNumber = collects[i].reqNumber;\r\n                            return true;\r\n                        }\r\n                        return false;\r\n                    });\r\n                    allItems.push(...items)\r\n                });\r\n\r\n        }\r\n        deliveryModel.setProperty('/oData/multiCollectItems', allItems);\r\n    }\r\n    loadCollects(deliveryModel: JSONModel) {\r\n        const collectsList = deliveryModel.getProperty('/oData/collectList') as ICollectRequest[];\r\n        if (collectsList) {\r\n            const selCollects = collectsList.filter(coll => coll.selected);\r\n            selCollects.map((el, i) => el.reqNumber = i + 1)\r\n            deliveryModel.setProperty('/oMaintain/multiCollect/currCollects', selCollects);\r\n            return selCollects\r\n        }\r\n        return []\r\n    }\r\n    public onStartCollectDialog(oEvent: Event) {\r\n        const deliveryModel = this.getDelivModel();\r\n        // check if have error before start -- need to fetch server\r\n        deliveryModel.setProperty('/oMaintain/share/showStartDialog', true);\r\n        void this.onFragmentHandler(oEvent, 'Dialog_StartCollect', true)\r\n        deliveryModel.setProperty('/oMaintain/multiCollect/start', true);\r\n        setTimeout(() => {\r\n            void this.cancelFragment(oEvent, 'Dialog_StartCollect')\r\n        }, 1500)\r\n    }\r\n    public filter() {\r\n        const deliveryModel = this.getDelivModel(),\r\n            table = this.getView().byId('multiItemsTable') as Table,\r\n            oBinding = table.getBinding(\"items\") as ListBinding,\r\n            filters: Filter[] = [];\r\n        const collectFilters = deliveryModel.getProperty('/oMaintain/multiCollect/collectFilter') as string[]\r\n        const searchFilter = deliveryModel.getProperty('/oMaintain/multiCollect/searchFilter') as string\r\n\r\n        // search filters\r\n        searchFilter && filters.push(new Filter('catNum', FilterOperator.Contains, searchFilter))\r\n        // collect filters\r\n        const collectOrFilters = collectFilters.map(collectFilter => new Filter('reqNumber', FilterOperator.EQ, collectFilter));\r\n        collectOrFilters.length && filters.push(new Filter({ filters: collectOrFilters, and: false }))\r\n        oBinding.filter(filters)\r\n\r\n    }\r\n    public onFinishCollects(oEvent: Event) {\r\n        const table = this.getView().byId('multiItemsTable') as Table;\r\n        if (table.getItems().length === table.getSelectedItems().length) {\r\n            this.navTo('preview');\r\n            this.groupByCollectReq()\r\n\r\n        }\r\n        else\r\n            MessageBox.show('לא סימנת את כל הפריטים')\r\n    }\r\n    private groupByCollectReq() {\r\n        const deliveryModel = this.getDelivModel();\r\n        const selCollects = deliveryModel.getProperty('/oMaintain/multiCollect/currCollects') as ICollectRequest[];\r\n        const collectsItems = deliveryModel.getProperty('/oData/multiCollectItems') as ICollectItem[];\r\n        const groupedCollects = selCollects.map(collect => {\r\n            const collectItems = collectsItems.filter(item => item.reqNumber === collect.reqNumber)\r\n            collect.items = collectItems;\r\n            return collect;\r\n        })\r\n        deliveryModel.setProperty('/oMaintain/multiCollect/previewItems', groupedCollects)\r\n        console.log(groupedCollects)\r\n    }\r\n\r\n\r\n}"],"mappings":"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"}